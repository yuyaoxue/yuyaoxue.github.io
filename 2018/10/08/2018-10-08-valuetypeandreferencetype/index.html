<!DOCTYPE html>
<html lang="en-us">
<head prefix="og: http://ogp.me/ns#">
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1" />
  <meta property="og:title" content=" C# 基础随笔之值类型与引用类型 &middot;  薛玉瑶的博客" />
  
  <meta name="theme-color" content="#hexcolor" />
 
  <meta property="og:site_name" content="薛玉瑶的博客" />
  <meta property="og:url" content="http://www.xueyuyao.com/2018/10/08/2018-10-08-valuetypeandreferencetype/" />
  
  
  <meta property="og:type" content="article" />
  
  <meta property="og:article:published_time" content="2018-10-08T08:24:52&#43;08:00" />
  
  

  <title>
     C# 基础随笔之值类型与引用类型 &middot;  薛玉瑶的博客
  </title>

  <link rel="stylesheet" href="http://www.xueyuyao.comcss/bootstrap.min.css" />
  <link rel="stylesheet" href="http://www.xueyuyao.comcss/main.css" />
  <link rel="stylesheet" href="http://www.xueyuyao.comcss/font-awesome.min.css" />
  <link rel="stylesheet" href="http://www.xueyuyao.comcss/github.css" />
  <link rel="stylesheet" href="//fonts.googleapis.com/css?family=Source+Sans+Pro:200,300,400" type="text/css">
  <link rel="shortcut icon" href="http://www.xueyuyao.comimages/favicon.ico" />
  <link rel="apple-touch-icon" href="http://www.xueyuyao.comimages/apple-touch-icon.png" />
  
</head>
<body>
    <header class="global-header"  style="background-image:url( /images/bg.jpg )">
    <section class="header-text">
      <h1><a href="http://www.xueyuyao.com">薛玉瑶的博客</a></h1>
      
      <div class="tag-line">
        每天都是一种练习
      </div>
      
      <div class="sns-links hidden-print">
  
  <a href="#ZgotmplZ">
    <i class="fa fa-envelope"></i>
  </a>
  
  
  
  
  <a href="https://plus.google.com/+yuyaoxue0617" target="_blank">
    <i class="fa fa-google"></i>
  </a>
  
  
  
  <a href="https://github.com/yuyaoxue" target="_blank">
    <i class="fa fa-github"></i>
  </a>
  
  
  
  
  
  
  
</div>

      
      <a href="http://www.xueyuyao.com" class="btn-header btn-back hidden-xs">
        <i class="fa fa-angle-left" aria-hidden="true"></i>
        &nbsp;Home
      </a>
      
      
    </section>
  </header>
  <main class="container">


<article>
  <header>
    <h1 class="text-primary">C# 基础随笔之值类型与引用类型</h1>
    <div class="post-meta clearfix">
    
      <div class="post-date pull-left">
        Posted on
        <time datetime="2018-10-08T08:24:52&#43;08:00">
          Oct 8, 2018
        </time>
      </div>
    
      <div class="pull-right">
        
      </div>
    </div>
  </header>
  <section>
    

<h1 id="前言">前言</h1>

<p>最近在温习 C# 语言基础，于是就整理了值类型和引用类型的随笔。</p>

<h2 id="值类型">值类型</h2>

<p>值类型的变量直接包含值，变量引用的位置就是值在内存中实际存储的位置。因此，将一个原始变量的值赋给另一个变量，会在新变量的位置创建原始变量的值的一个内存副本，改变一个值类型变量的值不会影响其他任何值类型的值，因为变量各有各有的存储位置。值类型的变量分配在托管栈上。</p>

<p>值类型包括：数值类型、结构体（struct）、bool 型、自定义结构体、枚举（enum）</p>

<h2 id="引用类型">引用类型</h2>

<p>引用类型的值存储的是对数据存储位置的引用，而不是直接存储数据。要去那个位置才能找到真正的数据。引用类型指向的内存区域称为堆。将引用类型的变量赋给另一个引用类型的变量，只会复制引用而不需要复制所引用的数据，所以两个不同的变量可引用相同的数据。</p>

<p>引用类型包括：数组、自定义的类、接口（interface）、委托（delegate）、object、字符串、null 类型、类（class）。</p>

<h2 id="值类型与引用类型的区别">值类型与引用类型的区别</h2>

<p>值类型和引用类型的区别源于复制策略的不同，每种类型在内存中以不同的方式存储。</p>

<p>存储方式：值类型直接存储数据本身；引用类型存储的是数据的引用，数据存储在数据堆中。</p>

<p>内存分配：值类型分配在栈（stack）上；引用类型分配在堆（heap）上</p>

<p>内存回收：值类型使用完之后立即回收；引用类型使用完之后不立即回收，而是交给 GC 处理回收。</p>

<p>赋值操作：值类型会复制一个数据的内存副本；引用类型会复制引用。</p>

<p>效率：值类型效率高，不需要地址转换；引用类型效率低，不需要进行地址转换。</p>

<h3 id="参数传递">参数传递</h3>

<p>参数传递包括值传递和引用传递。值传递是传递原始数据的拷贝；给参数加了ref（out）后，参数是引用传递，这时候传递的是引用地址。</p>

<h2 id="装箱与拆箱">装箱与拆箱</h2>

<p>《C#6.0 的本质论》中有装箱与拆箱的介绍：</p>

<pre><code>装箱是一个值类型转换为引用类型的过程。转换的结果必然是对一个存储位置的引用。该变量表面上包含引用类型的实例，但实际上包含值类型的值，

从值类型的变量（直接引用其数据）转换成引用类型（引用堆上的一个位置）时，会涉及以下几个步骤：

1：在堆上分配内存。它将用于存放值类型的数据以及少许额外开销（SyncBlockIndex 和方法表指针），这些额外开销使对象看起来像引用类型的托管对象实例。

2：接着发生一次内存复制，当前存储位置的值类型数据被复制到堆上分配好的位置。

3：转换结果是对堆上的心存储位置的引用。

相反的过程称为拆箱。拆箱转换先检查已装箱的值的类型兼容于要拆箱成的值的类型，然后复制堆中存储的值。

装箱和拆箱之所以重要，是因为装箱会影响性能和行为。每个装箱操作都涉及内存分配和复制，每个拆箱操作都涉及类型检查和复制。

如果装箱和拆箱进行得不是很频繁，它们实现的性能问题不大。但有时候，装箱很容易被忽视，而且会非常频繁地发生，这就可能大幅度影响性能。
</code></pre>

<h2 id="内存分配">内存分配</h2>

<p>在 《Unity 2017 Game Optimization - Second Edition》中有对值类型和引用类型内存分配的介绍：</p>

<p>Not all memory allocations we make within Mono will go through the heap.
The .NET Framework (and, by extension, the C# language, which merely implements the .NET specification) has the concept of Value types and Reference types, and only the latter needs to be marked by the GC while it is performing its Mark-and-Sweep algorithm.Reference types are expected to (or need to) last a long time in memory due to their complexity, their size, or how they&rsquo;re used. Large datasets,and any kind of object instantiated from a class, is a Reference type.This also includes arrays (regardless of whether it is an array of Value types or Reference types), delegates, all classes, such as MonoBehaviour, GameObject, and any custom classes we define.</p>

<p>Reference types are always allocated on the heap, whereas Value types can be allocated either on the stack or the heap. Primitive data types such as bool, int, and float are examples of Value types.These values are typically allocated on the stack, but as soon as a Value type is contained within a Reference type, such as a class or an array, then it is implied that it is either too large for the stack or will need to survive longer than the current scope and must be allocated on the heap, bundled with the Reference type it is contained within.</p>

<h2 id="总结">总结</h2>

<p>整理了一些值类型和引用类型的内容，也加深了自己对值类型和引用类型的理解。总结的比较基础，《C# 本质论》里对值类型和引用类型有更深入的介绍，有兴趣的可以深入研究。</p>

  </section>
  <footer>
    
    
    <hr/>
    <div id="disqus_thread"></div>
    <script type="text/javascript">
      var disqus_shortname = 'Your disqus shortname';
      (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
      })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
    
    
    <section class="author-info row">
      <div class="author-avatar col-md-2">
        
        <img alt="Author Avatar" src="/path/to/avatar" />
        
      </div>
      <div class="author-meta col-md-6">
        
        <h1 class="author-name text-primary">xueyuyao</h1>
        
        
        <div class="author-bio">Your short bio</div>
        
      </div>
      
      <div class="author-contact col-md-4">
        <a href="#ZgotmplZ">
          <i class="fa fa-envelope-o" aria-hidden="true"></i>
          &nbsp;Contact me
        </a>
      </div>
      
    </section>
    <ul class="pager">
      
      <li class="previous"><a href="http://www.xueyuyao.com/2018/09/27/2018-09-27-unity-2017-game-optimization/"><span aria-hidden="true">&larr;</span> Older</a></li>
      
      
      <li class="next disabled"><a href="#">Newer <span aria-hidden="true">&rarr;</span></a></li>
      
    </ul>
  </footer>
</article>

  </main>
  <footer class="container global-footer">
    <div class="copyright-note pull-left">
      &copy; Copyright notice
    </div>
    <div class="sns-links hidden-print">
  
  <a href="#ZgotmplZ">
    <i class="fa fa-envelope"></i>
  </a>
  
  
  
  
  <a href="https://plus.google.com/+yuyaoxue0617" target="_blank">
    <i class="fa fa-google"></i>
  </a>
  
  
  
  <a href="https://github.com/yuyaoxue" target="_blank">
    <i class="fa fa-github"></i>
  </a>
  
  
  
  
  
  
  
</div>

  </footer>

  <script src="http://www.xueyuyao.comjs/highlight.pack.js"></script>
  <script>
    hljs.initHighlightingOnLoad();
  </script>
  
  <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
    ga('create', 'Your Google Analytics tracking id', 'auto');
    ga('send', 'pageview');
  </script>
  
  
  <script type="text/javascript">(function(f,b){if(!b.__SV){var a,e,i,g;window.mixpanel=b;b._i=[];b.init=function(a,e,d){function f(b,h){var a=h.split(".");2==a.length&&(b=b[a[0]],h=a[1]);b[h]=function(){b.push([h].concat(Array.prototype.slice.call(arguments,0)))}}var c=b;"undefined"!==typeof d?c=b[d]=[]:d="mixpanel";c.people=c.people||[];c.toString=function(b){var a="mixpanel";"mixpanel"!==d&&(a+="."+d);b||(a+=" (stub)");return a};c.people.toString=function(){return c.toString(1)+".people (stub)"};i="disable track track_pageview track_links track_forms register register_once alias unregister identify name_tag set_config people.set people.set_once people.increment people.append people.track_charge people.clear_charges people.delete_user".split(" ");
  for(g=0;g<i.length;g++)f(c,i[g]);b._i.push([a,e,d])};b.__SV=1.2;a=f.createElement("script");a.type="text/javascript";a.async=!0;a.src="//cdn.mxpnl.com/libs/mixpanel-2-latest.min.js";e=f.getElementsByTagName("script")[0];e.parentNode.insertBefore(a,e)}})(document,window.mixpanel||[]);
  mixpanel.init("Your Mixpanel API key");</script>
  
</body>
</html>

